@echo off
setlocal enabledelayedexpansion

rem Prompt the user to enter the repository URLs and branch names
set /p repos=Enter the repository URLs and branch names (e.g. git@github.com:username/repo1.git:main git@github.com:username/repo2.git:develop):

rem Set the Maven command to run
set mvn_command=mvn -f pom.xml dependency:list -DincludeScope=runtime -DoutputFile=- -DoutputAbsoluteArtifactFilename=true -DoutputAbsoluteVersion=true

rem Set the output file name
set mvn_output_file=maven-dependencies.csv

rem Loop through each repository URL and branch name
for %%r in (%repos%) do (
    rem Extract the repository name from the URL
    for /f "tokens=2 delims=:/" %%i in ("%%~r") do set repo_name=%%i
    set repo_name=!repo_name:.git=!

    rem Split the URL and branch name
    for /f "tokens=2 delims=:" %%u in ("%%~r") do set branch_name=%%u

    rem Clone the repository and checkout the specified branch
    git clone --depth=1 --branch !branch_name! --single-branch %%~r /tmp/!repo_name!

    rem Change to the repository directory
    cd /tmp/!repo_name!

    rem List the Maven dependencies and write to CSV
    %mvn_command% | findstr /i ".jar" > %mvn_output_file%

    rem Delete the temporary directory
    cd ..
    rmdir /s /q !repo_name!
)

echo Done!
